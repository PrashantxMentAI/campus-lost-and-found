/**
 * Core Philosophy: This ruleset implements a public "lost and found board" model.
 * It allows anyone to view all submitted items to maximize the chance of
 * reuniting people with their property. To prevent abuse from unauthenticated
 * scripts, all write operations (creating, editing, deleting) require the user
 * to have an active session, which can be an anonymous one provided by Firebase
 * Authentication.
 *
 * Data Structure: The database consists of a single top-level collection named
 * `lost_found_items`, where each document represents a single lost or found item.
 * There are no user-specific subcollections.
 *
 * Key Security Decisions:
 * - Public Read Access: All data in the `lost_found_items` collection is
 *   publicly readable and listable to everyone, including users who are not
 *   signed in. This is essential for the application's function.
 * - Authenticated Writes: While the board is public, creating, updating, or
 *   deleting an item requires a valid authentication token. This allows anyone
 *   using the application (who will be given an anonymous session) to contribute,
 *   while providing a layer of protection against unauthorized automated writes.
 * - Ownership: To allow users to manage their own posts, an ownership model
 *   is implemented using a `userId` field on each item. Only the user who
 *   created an item can update or delete it.
 *
 * Denormalization for Authorization: This principle is not applicable here as
 * the security model is not based on ownership or relational data. All
 * authorization decisions are global.
 *
 * Structural Segregation: This principle is not applicable as all data is
 * considered public from the moment of creation. There is no distinction between
 * private and public content.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // Helper Functions

    /**
     * Checks if a user is authenticated, including anonymous sessions.
     */
    function isSignedIn() {
      return request.auth != null;
    }

    /**
     * Checks if the requesting user is the owner of the document.
     */
    function isOwner(doc) {
      return request.auth.uid == doc.userId;
    }

    /**
     * @description Allows public read access to all items. Allows any signed-in
     *              user (including anonymous users) to create new items.
     *              Only the original author can update or delete an item.
     */
    match /lost_found_items/{lostFoundItemId} {
      allow get: if true;
      allow list: if true;
      allow create: if isSignedIn() && request.resource.data.userId == request.auth.uid;
      allow update: if isSignedIn() && isOwner(resource.data);
      allow delete: if isSignedIn();

      /**
       * @description Defines rules for the 'queries' subcollection on each item.
       * @path        /lost_found_items/{lostFoundItemId}/queries/{queryId}
       * @allow       (list, get): Any user can read queries.
       * @allow       (create): Any signed-in user can post a query.
       */
       match /queries/{queryId} {
         allow list, get: if true;
         allow create: if isSignedIn() && request.resource.data.userId == request.auth.uid;
         allow update, delete: if false; // Queries are immutable for simplicity
       }
    }
  }
}
